<?xml version="1.0" encoding="UTF-8"?>
<project basedir=".." name="SALVADOR.HTTP" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
    <description>HTTP targets of the SUB Ant library</description>
    
    <!-- Import base lib -->
    <import file="../build.xml"/>
    <!-- Import Groovy -->
    <import file="./groovy.xml"/>
    
    <target name="salvador.http.macros" depends="salvador.groovy.install, salvador.base.ant.contrib.install">
        <macrodef name="salvador.http.postfile">
            <attribute name="url"/>
            <attribute name="file"/>
            <attribute name="name"/>
            <attribute name="param.name" value="file"/>
            <sequential>
                <!-- This is a ugly hack, see:
                     http://groovy.329449.n5.nabble.com/Accessing-Ant-macrodef-parameters-in-groovy-Ant-task-td358094.html
                -->
                <var name="urlProp" value="@{url}"/>
                <var name="fileProp" value="@{file}" />  
                <var name="nameProp" value="@{name}" />
                <var name="param.nameProp" value="@{param.name}" />  
                
                <groovy useGroovyShell="true">
                    /* Needed dependencies */
                    @Grapes([
                        @Grab(group='org.apache.httpcomponents', module='httpclient', version='4.0.1'),
                        @Grab(group='org.apache.httpcomponents', module='httpmime', version='4.0.1')
                    ])
                    
                    /* Needed imports */
                    import org.apache.http.*
                    import org.apache.http.client.*
                    import org.apache.http.entity.mime.*
                    import org.apache.http.entity.mime.content.*
                    import org.apache.http.impl.client.*
                    import org.apache.http.client.methods.*
                    
                    /* Get variable from ant */
                    def filePath = new File(properties['fileProp'])
                    def fileName = properties['nameProp']
                    def url = new URL(properties['urlProp'])
                    def paramName = properties['param.nameProp']
                    
                    /* See http://stackoverflow.com/questions/1378920/how-can-i-make-a-multipart-form-data-post-request-using-java */
                    HttpClient httpclient = new DefaultHttpClient();
                    HttpPost httppost = new HttpPost(url.toURI());
                    
                    FileBody bin = new FileBody(filePath);
                    StringBody comment = new StringBody("Filename: " + fileName);
                    
                    MultipartEntity reqEntity = new MultipartEntity();
                    reqEntity.addPart(paramName, bin);
                    reqEntity.addPart("comment", comment);
                    httppost.setEntity(reqEntity);
                    
                    HttpResponse response = httpclient.execute(httppost);
                    HttpEntity resEntity = response.getEntity();
                    
                    httpclient.getConnectionManager().shutdown();
                </groovy>
            </sequential>
            
        </macrodef>
    </target>
    
</project>