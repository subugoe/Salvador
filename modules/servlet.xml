<?xml version="1.0" encoding="UTF-8"?>
<project basedir=".." name="SALVADOR.SERVLET" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
 <description>Servlets targets of the SUB Ant library</description>

 <!-- Import base lib -->
 <import file="../build.xml"/>
 <!-- Dependencies -->
 <import file="./saxon.xml"/>

 <target name="salvador.servlet.install" depends="salvador.saxon.install, salvador.base.ant.contrib.install">
  <macrodef name="salvador.servlet.merge.single">
   <!-- Input files -->
   <attribute name="in1"/>
   <attribute name="in2"/>
   <!-- Output file -->
   <attribute name="out"/>
   <sequential>
    <xslt in="@{in1}" out="@{out}">
     <style>
      <!-- This inline stylesheet removes all references to URL rewriting -->
      <!-- See https://issues.apache.org/bugzilla/show_bug.cgi?id=32461 -->
      <string>
       <![CDATA[
       <xsl:stylesheet xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:j2ee="http://java.sun.com/xml/ns/j2ee" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
        exclude-result-prefixes="j2ee" version="1.0">
        <!-- Taken from https://scm.mmbase.org/didactor/trunk/old-ant-build/merge-web.xml.xslt -->
        <xsl:output method="xml" standalone="yes" indent="yes"/>
        <xsl:param name="mergeXmlFile"/>
        <xsl:variable name="mergeXml" select="document($mergeXmlFile)"/>
        <xsl:template match="/j2ee:web-app">
         <web-app xmlns="http://java.sun.com/xml/ns/j2ee">
          <xsl:copy-of select="@*"/>
          <xsl:apply-templates select="j2ee:description"/>
          <xsl:apply-templates select="j2ee:display-name"/>
          <xsl:apply-templates select="j2ee:context-param"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:context-param"/>
          <xsl:apply-templates select="j2ee:filter"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:filter"/>
          <xsl:apply-templates select="j2ee:filter-mapping"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:filter-mapping"/>
          <xsl:apply-templates select="j2ee:listener"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:listener"/>
          <xsl:apply-templates select="j2ee:servlet"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:servlet"/>
          <xsl:apply-templates select="j2ee:servlet-mapping"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:servlet-mapping"/>
          <xsl:apply-templates select="j2ee:mime-mapping"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:mime-mapping"/>
          <xsl:apply-templates select="j2ee:welcome-file-list"/>
          <xsl:apply-templates select="j2ee:taglib"/>
          <xsl:apply-templates select="$mergeXml/j2ee:web-app/j2ee:taglib"/>
          <xsl:apply-templates select="j2ee:error-page"/>
         </web-app>
        </xsl:template>
        <xsl:template match="text()">
         <xsl:copy-of select="."/>
        </xsl:template>
        <xsl:template match="j2ee:*">
         <xsl:element name="{name()}">
          <xsl:copy-of select="@*"/>
          <xsl:apply-templates select="text()|*"/>
         </xsl:element>
        </xsl:template>
       </xsl:stylesheet>
      ]]>
      </string>
     </style>
     <param name="mergeXmlFile" expression="@{in2}" type="STRING"/>
    </xslt>
   </sequential>
  </macrodef>
  <macrodef name="salvador.servlet.merge">
   <!-- 
   <element name="files" implicit="yes"/>
   -->
   <attribute name="refid"/>
   <attribute name="out"/>
   <sequential>
    <for param="png.file">
     <path>
      <fileset refid="@{refid}"/>
     </path>
     <sequential>
      <salvador.servlet.merge.single/>
     </sequential>
    </for>
   </sequential>
  </macrodef>

 </target>
</project>
